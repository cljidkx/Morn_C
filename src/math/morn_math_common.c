/*
Copyright (C) 2019-2020 JingWeiZhangHuai <jingweizhanghuai@163.com>
Licensed under the Apache License, Version 2.0; you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/

#include "morn_math.h"

char morn_float_sup[8] = {0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f};
char morn_float_inf[8] = {0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe};

double morn_sin0[450]={0.000000000000000,0.017452406437284,0.034899496702501,0.052335956242944,0.069756473744125,0.087155742747658,0.104528463267653,0.121869343405147,0.139173100960065,0.156434465040231,0.173648177666930,0.190808995376545,0.207911690817759,0.224951054343865,0.241921895599668,0.258819045102521,0.275637355816999,0.292371704722737,0.309016994374947,0.325568154457157,0.342020143325669,0.358367949545300,0.374606593415912,0.390731128489274,0.406736643075800,0.422618261740699,0.438371146789077,0.453990499739547,0.469471562785891,0.484809620246337,0.500000000000000,0.515038074910054,0.529919264233205,0.544639035015027,0.559192903470747,0.573576436351046,0.587785252292473,0.601815023152048,0.615661475325658,0.629320391049837,0.642787609686539,0.656059028990507,0.669130606358858,0.681998360062498,0.694658370458997,0.707106781186547,0.719339800338651,0.731353701619170,0.743144825477394,0.754709580222772,0.766044443118978,0.777145961456971,0.788010753606722,0.798635510047293,0.809016994374947,0.819152044288992,0.829037572555042,0.838670567945424,0.848048096156426,0.857167300702112,0.866025403784439,0.874619707139396,0.882947592858927,0.891006524188368,0.898794046299167,0.906307787036650,0.913545457642601,0.920504853452440,0.927183854566787,0.933580426497202,0.939692620785908,0.945518575599317,0.951056516295154,0.956304755963035,0.961261695938319,0.965925826289068,0.970295726275996,0.974370064785235,0.978147600733806,0.981627183447664,0.984807753012208,0.987688340595138,0.990268068741570,0.992546151641322,0.994521895368273,0.996194698091746,0.997564050259824,0.998629534754574,0.999390827019096,0.999847695156391,1.000000000000000,0.999847695156391,0.999390827019096,0.998629534754574,0.997564050259824,0.996194698091746,0.994521895368273,0.992546151641322,0.990268068741570,0.987688340595138,0.984807753012208,0.981627183447664,0.978147600733806,0.974370064785235,0.970295726275996,0.965925826289068,0.961261695938319,0.956304755963036,0.951056516295154,0.945518575599317,0.939692620785908,0.933580426497202,0.927183854566787,0.920504853452440,0.913545457642601,0.906307787036650,0.898794046299167,0.891006524188368,0.882947592858927,0.874619707139396,0.866025403784439,0.857167300702112,0.848048096156426,0.838670567945424,0.829037572555042,0.819152044288992,0.809016994374947,0.798635510047293,0.788010753606722,0.777145961456971,0.766044443118978,0.754709580222772,0.743144825477394,0.731353701619171,0.719339800338651,0.707106781186548,0.694658370458997,0.681998360062499,0.669130606358858,0.656059028990507,0.642787609686539,0.629320391049838,0.615661475325658,0.601815023152048,0.587785252292473,0.573576436351046,0.559192903470747,0.544639035015027,0.529919264233205,0.515038074910054,0.500000000000000,0.484809620246337,0.469471562785891,0.453990499739547,0.438371146789077,0.422618261740699,0.406736643075800,0.390731128489274,0.374606593415912,0.358367949545300,0.342020143325669,0.325568154457157,0.309016994374948,0.292371704722737,0.275637355817000,0.258819045102521,0.241921895599668,0.224951054343865,0.207911690817759,0.190808995376545,0.173648177666930,0.156434465040231,0.139173100960066,0.121869343405148,0.104528463267654,0.087155742747659,0.069756473744126,0.052335956242944,0.034899496702501,0.017452406437283,0.000000000000000,-0.017452406437283,-0.034899496702501,-0.052335956242944,-0.069756473744125,-0.087155742747658,-0.104528463267653,-0.121869343405148,-0.139173100960066,-0.156434465040231,-0.173648177666930,-0.190808995376545,-0.207911690817759,-0.224951054343865,-0.241921895599668,-0.258819045102520,-0.275637355816999,-0.292371704722736,-0.309016994374948,-0.325568154457157,-0.342020143325669,-0.358367949545300,-0.374606593415912,-0.390731128489274,-0.406736643075800,-0.422618261740699,-0.438371146789077,-0.453990499739546,-0.469471562785891,-0.484809620246337,-0.500000000000000,-0.515038074910054,-0.529919264233205,-0.544639035015027,-0.559192903470747,-0.573576436351046,-0.587785252292473,-0.601815023152048,-0.615661475325658,-0.629320391049838,-0.642787609686539,-0.656059028990507,-0.669130606358858,-0.681998360062498,-0.694658370458997,-0.707106781186547,-0.719339800338651,-0.731353701619170,-0.743144825477394,-0.754709580222772,-0.766044443118978,-0.777145961456971,-0.788010753606722,-0.798635510047293,-0.809016994374947,-0.819152044288992,-0.829037572555041,-0.838670567945424,-0.848048096156426,-0.857167300702112,-0.866025403784438,-0.874619707139396,-0.882947592858927,-0.891006524188368,-0.898794046299167,-0.906307787036650,-0.913545457642601,-0.920504853452440,-0.927183854566787,-0.933580426497202,-0.939692620785908,-0.945518575599317,-0.951056516295154,-0.956304755963035,-0.961261695938319,-0.965925826289068,-0.970295726275996,-0.974370064785235,-0.978147600733806,-0.981627183447664,-0.984807753012208,-0.987688340595138,-0.990268068741570,-0.992546151641322,-0.994521895368273,-0.996194698091746,-0.997564050259824,-0.998629534754574,-0.999390827019096,-0.999847695156391,-1.000000000000000,-0.999847695156391,-0.999390827019096,-0.998629534754574,-0.997564050259824,-0.996194698091746,-0.994521895368273,-0.992546151641322,-0.990268068741570,-0.987688340595138,-0.984807753012208,-0.981627183447664,-0.978147600733806,-0.974370064785235,-0.970295726275997,-0.965925826289068,-0.961261695938319,-0.956304755963035,-0.951056516295154,-0.945518575599317,-0.939692620785909,-0.933580426497202,-0.927183854566787,-0.920504853452440,-0.913545457642601,-0.906307787036650,-0.898794046299167,-0.891006524188368,-0.882947592858927,-0.874619707139396,-0.866025403784439,-0.857167300702112,-0.848048096156426,-0.838670567945424,-0.829037572555042,-0.819152044288992,-0.809016994374948,-0.798635510047293,-0.788010753606722,-0.777145961456971,-0.766044443118978,-0.754709580222772,-0.743144825477395,-0.731353701619171,-0.719339800338652,-0.707106781186548,-0.694658370458998,-0.681998360062498,-0.669130606358858,-0.656059028990507,-0.642787609686540,-0.629320391049838,-0.615661475325659,-0.601815023152048,-0.587785252292473,-0.573576436351046,-0.559192903470747,-0.544639035015027,-0.529919264233206,-0.515038074910054,-0.500000000000000,-0.484809620246337,-0.469471562785891,-0.453990499739547,-0.438371146789077,-0.422618261740700,-0.406736643075800,-0.390731128489275,-0.374606593415912,-0.358367949545301,-0.342020143325669,-0.325568154457158,-0.309016994374948,-0.292371704722736,-0.275637355817000,-0.258819045102521,-0.241921895599668,-0.224951054343865,-0.207911690817760,-0.190808995376545,-0.173648177666931,-0.156434465040231,-0.139173100960066,-0.121869343405148,-0.104528463267653,-0.087155742747658,-0.069756473744125,-0.052335956242944,-0.034899496702501,-0.017452406437284,0.000000000000000,0.017452406437283,0.034899496702500,0.052335956242944,0.069756473744125,0.087155742747659,0.104528463267653,0.121869343405148,0.139173100960065,0.156434465040231,0.173648177666930,0.190808995376545,0.207911690817759,0.224951054343865,0.241921895599668,0.258819045102520,0.275637355816999,0.292371704722737,0.309016994374947,0.325568154457156,0.342020143325669,0.358367949545299,0.374606593415912,0.390731128489273,0.406736643075800,0.422618261740700,0.438371146789077,0.453990499739547,0.469471562785890,0.484809620246337,0.499999999999999,0.515038074910054,0.529919264233205,0.544639035015027,0.559192903470746,0.573576436351046,0.587785252292474,0.601815023152048,0.615661475325658,0.629320391049837,0.642787609686539,0.656059028990507,0.669130606358858,0.681998360062498,0.694658370458997,0.707106781186547,0.719339800338651,0.731353701619171,0.743144825477394,0.754709580222772,0.766044443118978,0.777145961456971,0.788010753606721,0.798635510047293,0.809016994374947,0.819152044288991,0.829037572555042,0.838670567945424,0.848048096156426,0.857167300702112,0.866025403784439,0.874619707139395,0.882947592858927,0.891006524188368,0.898794046299167,0.906307787036650,0.913545457642601,0.920504853452441,0.927183854566787,0.933580426497202,0.939692620785908,0.945518575599317,0.951056516295154,0.956304755963036,0.961261695938319,0.965925826289068,0.970295726275996,0.974370064785235,0.978147600733806,0.981627183447664,0.984807753012208,0.987688340595138,0.990268068741570,0.992546151641322,0.994521895368273,0.996194698091745,0.997564050259824,0.998629534754574,0.999390827019096,0.999847695156391};
double *morn_cos0=morn_sin0+90;
double morn_sin1[100]={-0.008726535498374,-0.008552009086827,-0.008377482414771,-0.008202955487522,-0.008028428310396,-0.007853900888711,-0.007679373227783,-0.007504845332927,-0.007330317209461,-0.007155788862700,-0.006981260297962,-0.006806731520562,-0.006632202535817,-0.006457673349044,-0.006283143965559,-0.006108614390678,-0.005934084629719,-0.005759554687997,-0.005585024570828,-0.005410494283530,-0.005235963831420,-0.005061433219812,-0.004886902454025,-0.004712371539373,-0.004537840481175,-0.004363309284747,-0.004188777955404,-0.004014246498464,-0.003839714919243,-0.003665183223057,-0.003490651415224,-0.003316119501059,-0.003141587485880,-0.002967055375002,-0.002792523173742,-0.002617990887418,-0.002443458521345,-0.002268926080840,-0.002094393571219,-0.001919860997800,-0.001745328365898,-0.001570795680831,-0.001396262947914,-0.001221730172465,-0.001047197359800,-0.000872664515235,-0.000698131644088,-0.000523598751674,-0.000349065843310,-0.000174532924313,0.000000000000000,0.000174532924313,0.000349065843310,0.000523598751674,0.000698131644088,0.000872664515235,0.001047197359800,0.001221730172465,0.001396262947914,0.001570795680831,0.001745328365898,0.001919860997800,0.002094393571219,0.002268926080840,0.002443458521345,0.002617990887418,0.002792523173743,0.002967055375002,0.003141587485880,0.003316119501059,0.003490651415224,0.003665183223057,0.003839714919243,0.004014246498464,0.004188777955404,0.004363309284747,0.004537840481175,0.004712371539373,0.004886902454025,0.005061433219812,0.005235963831420,0.005410494283531,0.005585024570828,0.005759554687997,0.005934084629719,0.006108614390678,0.006283143965559,0.006457673349044,0.006632202535817,0.006806731520562,0.006981260297962,0.007155788862700,0.007330317209461,0.007504845332927,0.007679373227783,0.007853900888711,0.008028428310396,0.008202955487522,0.008377482414771,0.008552009086827};
double morn_cos1[100]={0.999961923064171,0.999963430901640,0.999964908278481,0.999966355194648,0.999967771650099,0.999969157644790,0.999970513178678,0.999971838251722,0.999973132863883,0.999974397015120,0.999975630705395,0.999976833934670,0.999978006702909,0.999979149010077,0.999980260856137,0.999981342241057,0.999982393164803,0.999983413627344,0.999984403628648,0.999985363168686,0.999986292247427,0.999987190864844,0.999988059020909,0.999988896715596,0.999989703948879,0.999990480720734,0.999991227031138,0.999991942880066,0.999992628267498,0.999993283193413,0.999993907657790,0.999994501660611,0.999995065201858,0.999995598281513,0.999996100899561,0.999996573055985,0.999997014750771,0.999997425983907,0.999997806755379,0.999998157065176,0.999998476913288,0.999998766299704,0.999999025224415,0.999999253687414,0.999999451688695,0.999999619228249,0.999999756306074,0.999999862922164,0.999999939076517,0.999999984769129,1.000000000000000,0.999999984769129,0.999999939076517,0.999999862922164,0.999999756306074,0.999999619228249,0.999999451688695,0.999999253687414,0.999999025224415,0.999998766299704,0.999998476913288,0.999998157065176,0.999997806755379,0.999997425983907,0.999997014750771,0.999996573055985,0.999996100899561,0.999995598281513,0.999995065201858,0.999994501660611,0.999993907657790,0.999993283193413,0.999992628267498,0.999991942880066,0.999991227031138,0.999990480720734,0.999989703948879,0.999988896715596,0.999988059020909,0.999987190864844,0.999986292247427,0.999985363168686,0.999984403628648,0.999983413627344,0.999982393164803,0.999981342241057,0.999980260856137,0.999979149010077,0.999978006702909,0.999976833934670,0.999975630705395,0.999974397015120,0.999973132863883,0.999971838251722,0.999970513178678,0.999969157644790,0.999967771650099,0.999966355194648,0.999964908278481,0.999963430901640};

float mSin(float a)
{
    double a0=ABS(a)*100;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double sn=morn_sin1[d]+morn_cos1[d]*e;
    double cs=morn_cos1[d]-morn_sin1[d]*e;
    float rst=morn_sin0[c]*cs+morn_cos0[c]*sn;
    return (a>0)?rst:(0-rst);
}

float mCos(float a)
{
    double a0=ABS(a)*100;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double sn=morn_sin1[d]+morn_cos1[d]*e;
    double cs=morn_cos1[d]-morn_sin1[d]*e;
    float rst=morn_cos0[c]*cs-morn_sin0[c]*sn;
    return rst;
}

void mMean(float *in,int num,float *sum,float *mean)
{
    float m;
    int i;
    mException((INVALID_POINTER(in))||(num <= 0),EXIT,"invalid input");
    
    m = 0.0f;
    for(i=0;i<num;i++)
        m = m + in[i];
    
    if(!INVALID_POINTER(sum)) *sum = m;
    if(!INVALID_POINTER(mean)) *mean = m/((float)num);
}

void mVariance(float *in,int num,float *mean,float *variance)
{
    float sum=0.0f;
    float var=0.0f;
    int i;
    mException((INVALID_POINTER(in))||(num <= 0)||(INVALID_POINTER(variance)),EXIT,"invalid input");
    
    for(i=0;i<num;i++)
    {
        sum = sum + in[i];
        var = var + in[i]*in[i];
    }
    sum = sum/((float)num);
    if(!INVALID_POINTER(mean)) *mean = sum;
    *variance = var/((float)num) - (sum*sum);
}

void mCovariance(float *in1,float *in2,int num,float *mean1,float *mean2,float *covariance)
{
    float sum1 = 0.0f;
    float sum2 = 0.0f;
    float cosum = 0.0f;
    int i;
    
    mException((INVALID_POINTER(in1))||(INVALID_POINTER(in2))||(num <= 0)||(INVALID_POINTER(covariance)),EXIT,"invalid input");
    for(i=0;i<num;i++)
    {
        sum1 =sum1 + in1[i];
        sum2 =sum2 + in2[i];
        cosum = cosum +in1[i] * in2[i];
    }
    sum1 = sum1/((float)num);
    sum2 = sum2/((float)num);
    if(!INVALID_POINTER(mean1)) *mean1 = sum1;
    if(!INVALID_POINTER(mean2)) *mean2 = sum1;
    *covariance = cosum/((float)num) - sum1*sum2;
}

#define MID_INDEX(I1,I2,I3) (((value[I1]>value[I2])==(value[I2]>=value[I3]))?I2:(((value[I1]>value[I2])==(value[I3]>=value[I1]))?I1:I3))
void mApproxMidValue(float *value,int num,float *mid,int *idx)
{
    int n;for(n=9;n<num/4;n=n*3);
    int *index = (int *)mMalloc(sizeof(int)*n);
    float step = (float)num/(float)n;for(int i=0;i<n;i++) index[i] = i*step;
    for(;n>1;n=n/3)
    {
        for(int i=0,j=0;i<n;i+=3,j+=1)
        {
            printf("%f,%f,%f",value[index[i]],value[index[i+1]],value[index[i+2]]);
            index[j] = MID_INDEX(index[i],index[i+1],index[i+2]);
            printf("-->%f\n",value[index[j]]);
        }
        printf("\n");
    }
    
    if(mid != NULL) *mid = value[index[0]];
    if(idx != NULL) *idx = index[0];
    
    mFree(index);
}



int _GreatestCommonDivisor(int a,int b)
{
    return b?_GreatestCommonDivisor(b,a%b):a;
}
int GreatestCommonDivisor(int n,...)
{
    va_list para;
    va_start(para,n);
    int a=va_arg(para,int);
    for(int i=1;i<n;i++)
    {
        int b=va_arg(para,int);
        a=_GreatestCommonDivisor(b,a);
    }
    va_end(para);
    return a;
}
int _LowestCommonMultiple(int a,int b)
{
    return (a/_GreatestCommonDivisor(a,b)*b);
}
int LowestCommonMultiple(int n,...)
{
    va_list para;
    va_start(para,n);
    int a=va_arg(para,int);
    for(int i=1;i<n;i++)
    {
        int b=va_arg(para,int);
        a=_LowestCommonMultiple(a,b);
    }
    va_end(para);
    return a;
}

int mBinaryCeil(int data)
{
    int floor = mBinaryFloor(data);
    if(floor==data) return data;
    return (data>0)?(floor*2):(floor/2);
}

int mBinaryFloor(int data)
{
    if (data<0) return (0-mBinaryCeil(0-data));
    int v[16]={0,1,2,2,4,4,4,4,8,8,8,8,8,8,8,8};
    if(data<16) return v[data];
    if(data<256) return (v[data>>4]<<4);
    if(data<4096) return (v[data>>8]<<8);
    if(data<65536) return (v[data>>12]<<12);
    if(data<1048576) return (v[data>>16]<<16);
    if(data<16777216) return (v[data>>20]<<20);
    if(data<268435456) return (v[data>>24]<<24);
    return (v[data>>28]<<28);
}

int mBinaryRound(int data)
{
    int floor = mBinaryFloor(data);
    int ceil = (data>0)?(floor*2):(floor/2);
    return ((ceil-data)<=(data-floor))?ceil:floor;
}

double mSigmoid(float x)
{
    return (1.0/(1.0+exp((double)(0.0f-x))));
}

unsigned int m_Hash(const char *in,int size)
{
    unsigned int out;
    int i;
    
    mException(INVALID_POINTER(in),EXIT,"invalid input");
    
    out = 0x811C9DC5;
    for(i=0;(size<=0)?(in[i]!='\0'):(i<=size);i++)
    {
        out = out^(unsigned int)in[i];
        out = (out<<24)+(out<<8)+(out<<6)+(out<<4)+(out<<3)+(out<<2)+out;
    }
    
    return out;
}
/*
struct HandlePermutation
{
    int *idx;
    int *flag;
    int num;
    int total;
};
void endPermutation(struct HandlePermutation *handle)
{
    if(handle->idx !=NULL) mFree(handle->idx );
    if(handle->flag!=NULL) mFree(handle->flag);
}
#define HASH_Permutation 0xf4740f4b
int mPermutation(int *idx,int num,int total)
{
    mException(INVALID_POINTER(idx),EXIT,"invalid input");
    MHandle *hdl = mHandle(mMornObject(idx,0),Permutation);
    struct HandlePermutation *handle = (struct HandlePermutation *)(hdl->handle);
    if(hdl->valid==0)
    {
        if(total<0) total=num;
        mException((num<0)||(num>total),EXIT,"invalid input combination number");
        if((handle->idx!=NULL)&&(handle->num<num)) {mFree(handle->idx);handle->idx=NULL;}
        if(handle->idx==NULL) handle->idx = (int *)mMalloc(num*sizeof(int));
        if((handle->flag!=NULL)&&(handle->total<total)) {mFree(handle->flag);handle->flag=NULL;}
        if(handle->flag==NULL) handle->flag= (int *)mMalloc(total*sizeof(int));
        for(int i=0;i<num;i++) {handle->idx[i]=i;handle->flag[i]=1;}
        for(int i=num;i<total;i++) handle->flag[i]=0;
        handle->num = num;handle->total=total;
        hdl->valid = 1;
        
        memcpy(idx,handle->idx,num*sizeof(int));
        return MORN_SUCCESS;
    }
    else
    {
        mException((handle->num  !=num  )&&(num  >0),EXIT,"invalid input combination number");num  =handle->num  ;
        mException((handle->total!=total)&&(total>0),EXIT,"invalid input combination number");total=handle->total;
    }

    int n;for(n=num-1;n>=0;n--)
    {
        int j = handle->idx[n];
        handle->flag[j]=0;
        for(j=handle->idx[n]+1;j<total;j++)
        {
            if(handle->flag[j]==0)
            {
                handle->idx[n]=j;
                handle->flag[j]=1;
                break;
            }
        }
        if(j<total) break;
        if(n==0) 
        {
            mFree(handle->idx );handle->idx =NULL;
            mFree(handle->flag);handle->flag=NULL;
            hdl->valid = 0;
            return MORN_FAIL;
        }
    }
    for(int i=n+1;i<num;i++)
    {
        for(int j=0;j<total;j++)
        {
            if(handle->flag[j]==0)
            {
                handle->idx[i]=j;
                handle->flag[j]=1;
                break;
            }
        }
    }
    memcpy(idx,handle->idx,num*sizeof(int));
    return MORN_SUCCESS;
}
*/


struct HandleCombination
{
    int *idx;
    int num;
    int array_num;
    int order;
};
void endCombination(struct HandleCombination *handle)
{
    if(handle->idx!=NULL) mFree(handle->idx);
}
#define HASH_Combination 0x110249ec
// int mCombination(int *idx,int num,int total)
int mCombination(MArray *array,int num)
{
    mException(INVALID_POINTER(array),EXIT,"invalid input");
    int array_num = array->num;
    MHandle *hdl = mHandle(array,Combination);
    struct HandleCombination *handle = (struct HandleCombination *)(hdl->handle);
    if(hdl->valid==0)
    {
        mException((num<0)||(num>array_num),EXIT,"invalid input combination number");
        if((handle->idx!=NULL)&&(handle->num<num)) {mFree(handle->idx);handle->idx=NULL;}
        if(handle->idx==NULL) handle->idx = (int *)mMalloc(num*sizeof(int));
        for(int i=0;i<num;i++) handle->idx[i]=i;
        handle->num = num;handle->array_num=array_num;
        hdl->valid = 1;

        memcpy(array->dataS32,handle->idx,num*sizeof(int));
        handle->order = 0;
        return handle->order;
    }
    mException((handle->num !=num)&&(num > 0),EXIT,"invalid input combination number");num=handle->num;
    mException((handle->array_num!=array_num),EXIT,"invalid input combination number");

    int n;for(n=num-1;n>=0;n--)
    {
        handle->idx[n]++;
        if(handle->idx[n]<=array_num-num+n) break;
    }
    if(n<0) 
    {
        mFree(handle->idx);handle->idx =NULL;
        hdl->valid = 0;
        return DFLT;
    }
    for(int i=n+1;i<num;i++) handle->idx[i]=handle->idx[i-1]+1;
    
    memcpy(array->dataS32,handle->idx,num*sizeof(int));
    handle->order++;
    return handle->order;
}

int m_Permutation(int *idx,int num)
{
    int buff;
    if(idx[num-2]<idx[num-1]) {buff=idx[num-2];idx[num-2]=idx[num-1];idx[num-1]=buff;return 1;}
    int n;for(n=num-3;n>=0;n--)
    {
        if(idx[n]<idx[n+1]) break;
    }
    if(n<0) return DFLT;
    int i,j;
    for(i=num-1;i>n;i--) {if(idx[i]>idx[n]) {buff=idx[n];idx[n]=idx[i];idx[i]=buff;break;}}
    for(i=num-1,j=n+1;i>j;i--,j++) {buff=idx[j];idx[j]=idx[i];idx[i]=buff;}
    return 1;
}

int mPermutation(MArray *array,int num)
{
    mException(INVALID_POINTER(array),EXIT,"invalid input");
    MHandle *hdl = mHandle(array,Combination);
    struct HandleCombination *handle = (struct HandleCombination *)(hdl->handle);

    if(hdl->valid==0) {mCombination(array,num);return 0;}
    
    if(m_Permutation(array->dataS32,num)>0) {handle->order++;return handle->order;}
    if(mCombination(array,num)>0) return handle->order;
    return -1;
}
