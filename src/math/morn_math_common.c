/*
Copyright (C) 2019-2020 JingWeiZhangHuai <jingweizhanghuai@163.com>
Licensed under the Apache License, Version 2.0; you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
*/

#include "morn_math.h"

char morn_float_sup[8] = {0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f};
char morn_float_inf[8] = {0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe};

static double morn_sin0[450]={0.0,0.017452406437284,0.034899496702501,0.052335956242944,0.069756473744125,0.087155742747658,0.104528463267653,0.121869343405147,0.139173100960065,0.156434465040231,0.173648177666930,0.190808995376545,0.207911690817759,0.224951054343865,0.241921895599668,0.258819045102521,0.275637355816999,0.292371704722737,0.309016994374947,0.325568154457157,0.342020143325669,0.358367949545300,0.374606593415912,0.390731128489274,0.406736643075800,0.422618261740699,0.438371146789077,0.453990499739547,0.469471562785891,0.484809620246337,0.500000000000000,0.515038074910054,0.529919264233205,0.544639035015027,0.559192903470747,0.573576436351046,0.587785252292473,0.601815023152048,0.615661475325658,0.629320391049837,0.642787609686539,0.656059028990507,0.669130606358858,0.681998360062498,0.694658370458997,0.707106781186547,0.719339800338651,0.731353701619170,0.743144825477394,0.754709580222772,0.766044443118978,0.777145961456971,0.788010753606722,0.798635510047293,0.809016994374947,0.819152044288992,0.829037572555042,0.838670567945424,0.848048096156426,0.857167300702112,0.866025403784439,0.874619707139396,0.882947592858927,0.891006524188368,0.898794046299167,0.906307787036650,0.913545457642601,0.920504853452440,0.927183854566787,0.933580426497202,0.939692620785908,0.945518575599317,0.951056516295154,0.956304755963035,0.961261695938319,0.965925826289068,0.970295726275996,0.974370064785235,0.978147600733806,0.981627183447664,0.984807753012208,0.987688340595138,0.990268068741570,0.992546151641322,0.994521895368273,0.996194698091746,0.997564050259824,0.998629534754574,0.999390827019096,0.999847695156391,1.000000000000000,0.999847695156391,0.999390827019096,0.998629534754574,0.997564050259824,0.996194698091746,0.994521895368273,0.992546151641322,0.990268068741570,0.987688340595138,0.984807753012208,0.981627183447664,0.978147600733806,0.974370064785235,0.970295726275996,0.965925826289068,0.961261695938319,0.956304755963036,0.951056516295154,0.945518575599317,0.939692620785908,0.933580426497202,0.927183854566787,0.920504853452440,0.913545457642601,0.906307787036650,0.898794046299167,0.891006524188368,0.882947592858927,0.874619707139396,0.866025403784439,0.857167300702112,0.848048096156426,0.838670567945424,0.829037572555042,0.819152044288992,0.809016994374947,0.798635510047293,0.788010753606722,0.777145961456971,0.766044443118978,0.754709580222772,0.743144825477394,0.731353701619171,0.719339800338651,0.707106781186548,0.694658370458997,0.681998360062499,0.669130606358858,0.656059028990507,0.642787609686539,0.629320391049838,0.615661475325658,0.601815023152048,0.587785252292473,0.573576436351046,0.559192903470747,0.544639035015027,0.529919264233205,0.515038074910054,0.500000000000000,0.484809620246337,0.469471562785891,0.453990499739547,0.438371146789077,0.422618261740699,0.406736643075800,0.390731128489274,0.374606593415912,0.358367949545300,0.342020143325669,0.325568154457157,0.309016994374948,0.292371704722737,0.275637355817000,0.258819045102521,0.241921895599668,0.224951054343865,0.207911690817759,0.190808995376545,0.173648177666930,0.156434465040231,0.139173100960066,0.121869343405148,0.104528463267654,0.087155742747659,0.069756473744126,0.052335956242944,0.034899496702501,0.017452406437283,0.000000000000000,-0.017452406437283,-0.034899496702501,-0.052335956242944,-0.069756473744125,-0.087155742747658,-0.104528463267653,-0.121869343405148,-0.139173100960066,-0.156434465040231,-0.173648177666930,-0.190808995376545,-0.207911690817759,-0.224951054343865,-0.241921895599668,-0.258819045102520,-0.275637355816999,-0.292371704722736,-0.309016994374948,-0.325568154457157,-0.342020143325669,-0.358367949545300,-0.374606593415912,-0.390731128489274,-0.406736643075800,-0.422618261740699,-0.438371146789077,-0.453990499739546,-0.469471562785891,-0.484809620246337,-0.500000000000000,-0.515038074910054,-0.529919264233205,-0.544639035015027,-0.559192903470747,-0.573576436351046,-0.587785252292473,-0.601815023152048,-0.615661475325658,-0.629320391049838,-0.642787609686539,-0.656059028990507,-0.669130606358858,-0.681998360062498,-0.694658370458997,-0.707106781186547,-0.719339800338651,-0.731353701619170,-0.743144825477394,-0.754709580222772,-0.766044443118978,-0.777145961456971,-0.788010753606722,-0.798635510047293,-0.809016994374947,-0.819152044288992,-0.829037572555041,-0.838670567945424,-0.848048096156426,-0.857167300702112,-0.866025403784438,-0.874619707139396,-0.882947592858927,-0.891006524188368,-0.898794046299167,-0.906307787036650,-0.913545457642601,-0.920504853452440,-0.927183854566787,-0.933580426497202,-0.939692620785908,-0.945518575599317,-0.951056516295154,-0.956304755963035,-0.961261695938319,-0.965925826289068,-0.970295726275996,-0.974370064785235,-0.978147600733806,-0.981627183447664,-0.984807753012208,-0.987688340595138,-0.990268068741570,-0.992546151641322,-0.994521895368273,-0.996194698091746,-0.997564050259824,-0.998629534754574,-0.999390827019096,-0.999847695156391,-1.000000000000000,-0.999847695156391,-0.999390827019096,-0.998629534754574,-0.997564050259824,-0.996194698091746,-0.994521895368273,-0.992546151641322,-0.990268068741570,-0.987688340595138,-0.984807753012208,-0.981627183447664,-0.978147600733806,-0.974370064785235,-0.970295726275997,-0.965925826289068,-0.961261695938319,-0.956304755963035,-0.951056516295154,-0.945518575599317,-0.939692620785909,-0.933580426497202,-0.927183854566787,-0.920504853452440,-0.913545457642601,-0.906307787036650,-0.898794046299167,-0.891006524188368,-0.882947592858927,-0.874619707139396,-0.866025403784439,-0.857167300702112,-0.848048096156426,-0.838670567945424,-0.829037572555042,-0.819152044288992,-0.809016994374948,-0.798635510047293,-0.788010753606722,-0.777145961456971,-0.766044443118978,-0.754709580222772,-0.743144825477395,-0.731353701619171,-0.719339800338652,-0.707106781186548,-0.694658370458998,-0.681998360062498,-0.669130606358858,-0.656059028990507,-0.642787609686540,-0.629320391049838,-0.615661475325659,-0.601815023152048,-0.587785252292473,-0.573576436351046,-0.559192903470747,-0.544639035015027,-0.529919264233206,-0.515038074910054,-0.500000000000000,-0.484809620246337,-0.469471562785891,-0.453990499739547,-0.438371146789077,-0.422618261740700,-0.406736643075800,-0.390731128489275,-0.374606593415912,-0.358367949545301,-0.342020143325669,-0.325568154457158,-0.309016994374948,-0.292371704722736,-0.275637355817000,-0.258819045102521,-0.241921895599668,-0.224951054343865,-0.207911690817760,-0.190808995376545,-0.173648177666931,-0.156434465040231,-0.139173100960066,-0.121869343405148,-0.104528463267653,-0.087155742747658,-0.069756473744125,-0.052335956242944,-0.034899496702501,-0.017452406437284,0.000000000000000,0.017452406437283,0.034899496702500,0.052335956242944,0.069756473744125,0.087155742747659,0.104528463267653,0.121869343405148,0.139173100960065,0.156434465040231,0.173648177666930,0.190808995376545,0.207911690817759,0.224951054343865,0.241921895599668,0.258819045102520,0.275637355816999,0.292371704722737,0.309016994374947,0.325568154457156,0.342020143325669,0.358367949545299,0.374606593415912,0.390731128489273,0.406736643075800,0.422618261740700,0.438371146789077,0.453990499739547,0.469471562785890,0.484809620246337,0.499999999999999,0.515038074910054,0.529919264233205,0.544639035015027,0.559192903470746,0.573576436351046,0.587785252292474,0.601815023152048,0.615661475325658,0.629320391049837,0.642787609686539,0.656059028990507,0.669130606358858,0.681998360062498,0.694658370458997,0.707106781186547,0.719339800338651,0.731353701619171,0.743144825477394,0.754709580222772,0.766044443118978,0.777145961456971,0.788010753606721,0.798635510047293,0.809016994374947,0.819152044288991,0.829037572555042,0.838670567945424,0.848048096156426,0.857167300702112,0.866025403784439,0.874619707139395,0.882947592858927,0.891006524188368,0.898794046299167,0.906307787036650,0.913545457642601,0.920504853452441,0.927183854566787,0.933580426497202,0.939692620785908,0.945518575599317,0.951056516295154,0.956304755963036,0.961261695938319,0.965925826289068,0.970295726275996,0.974370064785235,0.978147600733806,0.981627183447664,0.984807753012208,0.987688340595138,0.990268068741570,0.992546151641322,0.994521895368273,0.996194698091745,0.997564050259824,0.998629534754574,0.999390827019096,0.999847695156391};
static double *morn_cos0=morn_sin0+90;
static double morn_sin1[100]={-0.008726535498374,-0.008552009086827,-0.008377482414771,-0.008202955487522,-0.008028428310396,-0.007853900888711,-0.007679373227783,-0.007504845332927,-0.007330317209461,-0.007155788862700,-0.006981260297962,-0.006806731520562,-0.006632202535817,-0.006457673349044,-0.006283143965559,-0.006108614390678,-0.005934084629719,-0.005759554687997,-0.005585024570828,-0.005410494283530,-0.005235963831420,-0.005061433219812,-0.004886902454025,-0.004712371539373,-0.004537840481175,-0.004363309284747,-0.004188777955404,-0.004014246498464,-0.003839714919243,-0.003665183223057,-0.003490651415224,-0.003316119501059,-0.003141587485880,-0.002967055375002,-0.002792523173742,-0.002617990887418,-0.002443458521345,-0.002268926080840,-0.002094393571219,-0.001919860997800,-0.001745328365898,-0.001570795680831,-0.001396262947914,-0.001221730172465,-0.001047197359800,-0.000872664515235,-0.000698131644088,-0.000523598751674,-0.000349065843310,-0.000174532924313,0.000000000000000,0.000174532924313,0.000349065843310,0.000523598751674,0.000698131644088,0.000872664515235,0.001047197359800,0.001221730172465,0.001396262947914,0.001570795680831,0.001745328365898,0.001919860997800,0.002094393571219,0.002268926080840,0.002443458521345,0.002617990887418,0.002792523173743,0.002967055375002,0.003141587485880,0.003316119501059,0.003490651415224,0.003665183223057,0.003839714919243,0.004014246498464,0.004188777955404,0.004363309284747,0.004537840481175,0.004712371539373,0.004886902454025,0.005061433219812,0.005235963831420,0.005410494283531,0.005585024570828,0.005759554687997,0.005934084629719,0.006108614390678,0.006283143965559,0.006457673349044,0.006632202535817,0.006806731520562,0.006981260297962,0.007155788862700,0.007330317209461,0.007504845332927,0.007679373227783,0.007853900888711,0.008028428310396,0.008202955487522,0.008377482414771,0.008552009086827};
static double morn_cos1[100]={0.999961923064171,0.999963430901640,0.999964908278481,0.999966355194648,0.999967771650099,0.999969157644790,0.999970513178678,0.999971838251722,0.999973132863883,0.999974397015120,0.999975630705395,0.999976833934670,0.999978006702909,0.999979149010077,0.999980260856137,0.999981342241057,0.999982393164803,0.999983413627344,0.999984403628648,0.999985363168686,0.999986292247427,0.999987190864844,0.999988059020909,0.999988896715596,0.999989703948879,0.999990480720734,0.999991227031138,0.999991942880066,0.999992628267498,0.999993283193413,0.999993907657790,0.999994501660611,0.999995065201858,0.999995598281513,0.999996100899561,0.999996573055985,0.999997014750771,0.999997425983907,0.999997806755379,0.999998157065176,0.999998476913288,0.999998766299704,0.999999025224415,0.999999253687414,0.999999451688695,0.999999619228249,0.999999756306074,0.999999862922164,0.999999939076517,0.999999984769129,1.000000000000000,0.999999984769129,0.999999939076517,0.999999862922164,0.999999756306074,0.999999619228249,0.999999451688695,0.999999253687414,0.999999025224415,0.999998766299704,0.999998476913288,0.999998157065176,0.999997806755379,0.999997425983907,0.999997014750771,0.999996573055985,0.999996100899561,0.999995598281513,0.999995065201858,0.999994501660611,0.999993907657790,0.999993283193413,0.999992628267498,0.999991942880066,0.999991227031138,0.999990480720734,0.999989703948879,0.999988896715596,0.999988059020909,0.999987190864844,0.999986292247427,0.999985363168686,0.999984403628648,0.999983413627344,0.999982393164803,0.999981342241057,0.999980260856137,0.999979149010077,0.999978006702909,0.999976833934670,0.999975630705395,0.999974397015120,0.999973132863883,0.999971838251722,0.999970513178678,0.999969157644790,0.999967771650099,0.999966355194648,0.999964908278481,0.999963430901640};

double mSin(double a)
{
    double a0=ABS(a)*100.0;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000.0;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double f=e*e;
    double sn0=e-f*e/6.0;
    double cs0=1-f/2.0+f*f/24.0;

    double sn1=morn_sin1[d]*cs0+morn_cos1[d]*sn0;
    double cs1=morn_cos1[d]*cs0-morn_sin1[d]*sn0;
    double rst=morn_sin0[c]*cs1+morn_cos0[c]*sn1;
    return (a>0)?rst:(0-rst);
}

double mCos(double a)
{
    double a0=ABS(a)*100.0;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000.0;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double f=e*e;
    double sn0=e-f*e/6.0;
    double cs0=1-f/2.0+f*f/24.0;

    double sn1=morn_sin1[d]*cs0+morn_cos1[d]*sn0;
    double cs1=morn_cos1[d]*cs0-morn_sin1[d]*sn0;
    double rst=morn_cos0[c]*cs1-morn_sin0[c]*sn1;
    return rst;
}

double mSec(double a)
{
    return 1.0/mCos(a);
}

double mCsc(double a)
{
    return 1.0/mSin(a);
}

double mTan(double a)
{
    double a0=ABS(a)*100.0;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000.0;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double f=e*e;
    double sn0=e-f*e/6.0;
    double cs0=1-f/2.0+f*f/24.0;

    double sn1=morn_sin1[d]*cs0+morn_cos1[d]*sn0;
    double cs1=morn_cos1[d]*cs0-morn_sin1[d]*sn0;
    double sn=morn_sin0[c]*cs1+morn_cos0[c]*sn1;
    double cs=morn_cos0[c]*cs1-morn_sin0[c]*sn1;
    double rst=sn/cs;
    return (a>0)?rst:(0-rst);
}

double mCot(double a)
{
    double a0=ABS(a)*100.0;
    int b=(int)(a0+0.5);
    double e=(a0-(double)b)*MORN_PI/18000.0;
    int c=(b+50)/100;int d=b-c*100+50;c=c%360;

    double f=e*e;
    double sn0=e-f*e/6.0;
    double cs0=1-f/2.0+f*f/24.0;

    double sn1=morn_sin1[d]*cs0+morn_cos1[d]*sn0;
    double cs1=morn_cos1[d]*cs0-morn_sin1[d]*sn0;
    double sn=morn_sin0[c]*cs1+morn_cos0[c]*sn1;
    double cs=morn_cos0[c]*cs1-morn_sin0[c]*sn1;
    double rst=cs/sn;
    return (a>0)?rst:(0-rst);
}

static double morn_ln[100]={0.0,0.009950330853168,0.019802627296180,0.029558802241544,0.039220713153281,0.048790164169432,0.058268908123976,0.067658648473815,0.076961041136128,0.086177696241052,0.095310179804325,0.104360015324243,0.113328685307003,0.122217632724249,0.131028262406404,0.139761942375159,0.148420005118273,0.157003748809665,0.165514438477574,0.173953307123438,0.182321556793955,0.190620359608650,0.198850858745165,0.207014169384326,0.215111379616946,0.223143551314210,0.231111720963387,0.239016900470500,0.246860077931526,0.254642218373581,0.262364264467491,0.270027137213060,0.277631736598280,0.285178942233663,0.292669613962820,0.300104592450338,0.307484699747961,0.314810739840034,0.322083499169114,0.329303747142601,0.336472236621213,0.343589704390077,0.350656871613170,0.357674444271816,0.364643113587910,0.371563556432483,0.378436435720245,0.385262400790645,0.392042087776024,0.398776119957368,0.405465108108165,0.412109650826833,0.418710334858185,0.425267735404344,0.431782416425538,0.438254930931156,0.444685821261446,0.451075619360217,0.457424847038876,0.463734016232140,0.470003629245736,0.476234178996372,0.482426149244293,0.488580014818671,0.494696241836107,0.500775287912490,0.506817602368452,0.512823626428664,0.518793793415168,0.524728528934982,0.530628251062171,0.536493370514569,0.542324290825362,0.548121408509688,0.553885113226438,0.559615787935423,0.565313809050061,0.570979546585738,0.576613364303994,0.582215619852664,0.587786664902119,0.593326845277735,0.598836501088704,0.604315966853330,0.609765571620895,0.615185639090234,0.620576487725110,0.625938430866496,0.631271776841858,0.636576829071551,0.641853886172395,0.647103242058539,0.652325186039691,0.657520002916795,0.662687973075237,0.667829372575656,0.672944473242426,0.678033542749898,0.683096844706444,0.688134638736401};
static inline double m_Ln(double a)
{
    int64_t *b=(int64_t *)(&a);
    int c=((*b)>>52)-1023;
    double rst=((double)c)*0.69314718055994530941723212145818;
    
    *b = ((*b)&0x000fffffffffffff)|0x3ff0000000000000;
    int d=(int)(a*100.0);
    rst+=morn_ln[d-100];

    a=(a*100.0/(double)d)-1.0;
    double e=a*a;
    return (rst+a-e/2.0+e*a/3.0-e*e/4.0);
}

double mLn(double a)
{
    if(a<=0.0) return mNan();
    return m_Ln(a);
}
double mLg(double a)
{
    if(a<=0.0) return mNan();
    return m_Ln(a)/2.3025850929940456840179914546844;
}
double mLog2(double a)
{
    if(a<=0.0) return mNan();
    return m_Ln(a)/0.69314718055994530941723212145818;
}
double mLoga(double a,double b)
{
    if((a=0.0)||(b<=0.0)) return mNan();
    return m_Ln(b)/m_Ln(a);
}

static double morn_exp1[71]={1.0,2.202646579480672e+004,4.851651954097903e+008,1.068647458152446e+013,2.353852668370200e+017,5.184705528587072e+021,1.142007389815684e+026,2.515438670919167e+030,5.540622384393510e+034,1.220403294317841e+039,2.688117141816136e+043,5.920972027664670e+047,1.304180878393632e+052,2.872649550817832e+056,6.327431707155585e+060,1.393709580666380e+065,3.069849640644242e+069,6.761793810485009e+073,1.489384200781838e+078,3.280587015384671e+082,7.225973768125749e+086,1.591626640377924e+091,3.505790975238748e+095,7.722018499983836e+099,1.700887763567586e+104,3.746454614502673e+108,8.252115441813891e+112,1.817649385139100e+117,4.003639200871785e+121,8.818602191274965e+125,1.942426395241256e+130,4.278478855371123e+134,9.423976816163585e+138,2.075769029922787e+143,4.572185553551339e+147,1.007090887028080e+152,2.218265297538556e+156,4.886054470003974e+160,1.076225116551050e+165,2.370543571722357e+169,5.221469689764144e+173,1.150105235202100e+178,2.533275362360718e+182,5.579910311786494e+186,1.229057036206545e+191,2.707178276786998e+195,5.962956971409261e+199,1.313428677666503e+204,2.893019184253945e+208,6.372298810568915e+212,1.403592217852838e+217,3.091617597639242e+221,6.809740926502327e+225,1.499945255890989e+230,3.303849287296548e+234,7.277212331783397e+238,1.602912685075726e+243,3.530650142988227e+247,7.776774460795963e+251,1.712948566546487e+256,3.773020300929940e+260,8.310630260154467e+264,1.830538131585780e+269,4.032028554146358e+273,8.881133903158874e+277,1.956199921370272e+282,4.308817065586588e+286,9.490801171122244e+290,2.090488073610356e+295,4.604606404782990e+299};
static double morn_exp2[70]={1.0,4.539992976248485e-005,2.061153622438558e-009,9.357622968840175e-014,4.248354255291589e-018,1.928749847963918e-022,8.756510762696520e-027,3.975449735908647e-031,1.804851387845415e-035,8.194012623990515e-040,3.720075976020836e-044,1.688911880224532e-048,7.667648073722000e-053,3.481106839904311e-057,1.580420060273613e-061,7.175095973164411e-066,3.257488532207521e-070,1.478897505643213e-074,6.714184288211594e-079,3.048234950971857e-083,1.383896526736738e-087,6.282880511239462e-092,2.852423339163565e-096,1.294998192508984e-100,5.879282698245269e-105,2.669190215541276e-109,1.211810483082857e-113,5.501611081740457e-118,2.497727566915251e-122,1.133966561037746e-126,5.148200222412014e-131,2.337279285007143e-135,1.061123153746351e-139,4.817491664943076e-144,2.187137832197718e-148,9.929590396264980e-153,4.508027065606742e-157,2.046641121459268e-161,9.291736316326398e-166,4.218441761327482e-170,1.915169596714006e-174,8.694856517406230e-179,3.947458751851265e-183,1.792143500743535e-187,8.136318905805023e-192,3.693883068487256e-196,1.677020318601535e-200,7.613660467476964e-205,3.456596504588617e-209,1.569292385255739e-213,7.124576406741286e-218,3.234552684535111e-222,1.468484646909508e-226,6.666909982697905e-231,3.026772449472940e-235,1.374152566130957e-239,6.238642998528377e-244,2.832339539464062e-248,1.285880161551771e-252,5.837886901742308e-257,2.650396553004311e-261,1.203278173491277e-265,5.462874456123503e-270,2.480141166092796e-274,1.125982347416602e-278,5.111951948651156e-283,2.320822594179601e-287,1.053651827669418e-291,4.783571897030535e-296,2.171738281389827e-300};
static double morn_exp3[101]={1.0,1.105170918075648,1.221402758160170,1.349858807576003,1.491824697641270,1.648721270700128,1.822118800390509,2.013752707470477,2.225540928492467,2.459603111156949,2.718281828459045,3.004166023946433,3.320116922736547,3.669296667619244,4.055199966844675,4.481689070338065,4.953032424395117,5.473947391727202,6.049647464412949,6.685894442279273,7.389056098930653,8.166169912567655,9.025013499434127,9.974182454814727,11.023176380641610,12.182493960703484,13.463738035001704,14.879731724872849,16.444646771097069,18.174145369443085,20.085536923187693,22.197951281441664,24.532530197109384,27.112638920657929,29.964100047397064,33.115451958692375,36.598234443678059,40.447304360067470,44.701184493300914,49.402449105530280,54.598150033144336,60.340287597362057,66.686331040925211,73.699793699595844,81.450868664968141,90.017131300521811,99.484315641933776,109.94717245212343,121.51041751873476,134.28977968493530,148.41315910257634,164.02190729990139,181.27224187515074,200.33680997479112,221.40641620418637,244.69193226421953,270.42640742615157,298.86740096705898,330.29955990964714,365.03746786532696,403.42879349273295,445.85777008251438,492.74904109325325,544.57191012592557,601.84503787207802,665.14163304435715,735.09518924196743,812.40582516753682,897.84729165041040,992.27471560501738,1096.6331584284490,1211.9670744925654,1339.4307643944051,1480.2999275845305,1635.9844299959097,1808.0424144560438,1998.1958951040961,2208.3479918871835,2440.6019776244702,2697.2823282684762,2980.9579870416910,3294.4680752837994,3640.9503073323067,4023.8723938222556,4447.0667476997942,4914.7688402990643,5431.6595913629008,6002.9122172609323,6634.2440062777841,7331.9735391558779,8103.0839275752542,8955.2927034823661,9897.1290587437506,10938.019208164997,12088.380730216773,13359.726829661635,14764.781565577005,16317.607198015130,18033.744927828171,19930.370438229907,22026.465794806718};
static double morn_exp4[101]={1.0,1.001000500166708,1.002002001334000,1.003004504503377,1.004008010677342,1.005012520859401,1.006018036054065,1.007024557266849,1.008032085504274,1.009040621773868,1.010050167084168,1.011060722444720,1.012072288866078,1.013084867359809,1.014098458938492,1.015113064615719,1.016128685406095,1.017145322325241,1.018162976389794,1.019181648617408,1.020201340026756,1.021222051637529,1.022243784470438,1.023266539547218,1.024290317890622,1.025315120524429,1.026340948473442,1.027367802763489,1.028395684421425,1.029424594475131,1.030454533953517,1.031485503886523,1.032517505305119,1.033550539241306,1.034584606728118,1.035619708799623,1.036655846490924,1.037693020838157,1.038731232878498,1.039770483650158,1.040810774192388,1.041852105545480,1.042894478750763,1.043937894850613,1.044982354888444,1.046027859908717,1.047074410956937,1.048122009079656,1.049170655324471,1.050220350740028,1.051271096376024,1.052322893283204,1.053375742513365,1.054429645119356,1.055484602155080,1.056540614675494,1.057597683736611,1.058655810395500,1.059714995710288,1.060775240740159,1.061836546545360,1.062898914187195,1.063962344728034,1.065026839231306,1.066092398761505,1.067159024384193,1.068226717165993,1.069295478174600,1.070365308478774,1.071436209148346,1.072508181254217,1.073581225868358,1.074655344063814,1.075730536914703,1.076806805496220,1.077884150884632,1.078962574157284,1.080042076392600,1.081122658670083,1.082204322070315,1.083287067674959,1.084370896566760,1.085455809829549,1.086541808548238,1.087628893808826,1.088717066698399,1.089806328305129,1.090896679718278,1.091988122028198,1.093080656326330,1.094174283705210,1.095269005258466,1.096364822080817,1.097461735268082,1.098559745917174,1.099658855126103,1.100759063993979,1.101860373621011,1.102962785108508,1.104066299558882,1.105170918075648};
double mExp(double a)
{
    if((a>700.0)||(a<-700)) return mNan();
    double f=a;
    int b=(int)(f*1000.0);
    f-=(double)(b)/1000.0;
    int c=b/10000-(a<0);b-=c*10000;
    double rst=(a<0)?morn_exp2[0-c]:morn_exp1[c];
    
    int d=b/100;int e=b%100;
    rst=rst*morn_exp3[d]*morn_exp4[e];
    
    double g=f*f;
    return (1+f+g/2.0+g*f/6.0+g*g/24.0)*rst;
}

double mPow(double a,double b)
{
    if(a<=0.0) return mNan();
    return mExp(b*m_Ln(a));
}

double mSigmoid(double x)
{
    return (1.0/(1.0+mExp(0.0-x)));
}
double mDsigmoid(double x)
{
    double s=(1.0/(1.0+mExp(0.0-x)));
    return s*(1-s);
}

double mSinh(double x)
{
    double a=mExp(x);
    return (a-1.0/a)/2.0;
}

double mCosh(double x)
{
    double a=mExp(x);
    return (a+1.0/a)/2.0;
}

double mTanh(double x)
{
    double a=mExp(x);double b=1.0/a;
    return (a-b)/(a+b);
}

double mCoth(double x)
{
    double a=mExp(x);double b=1.0/a;
    return (a+b)/(a-b);
}

double mSech(double x)
{
    double a=mExp(x);
    return 2.0/(a+1.0/a);
}

double mCsch(double x)
{
    double a=mExp(x);
    return 2.0/(a-1.0/a);
}


// double morn_sqrt1[256]={7.66646708341687e-20,1.08420217248550e-19,1.53329341668337e-19,2.16840434497101e-19,3.06658683336675e-19,4.33680868994202e-19,6.13317366673350e-19,8.67361737988404e-19,1.22663473334670e-18,1.73472347597681e-18,2.45326946669340e-18,3.46944695195361e-18,4.90653893338680e-18,6.93889390390723e-18,9.81307786677359e-18,1.38777878078145e-17,1.96261557335472e-17,2.77555756156289e-17,3.92523114670944e-17,5.55111512312578e-17,7.85046229341888e-17,1.11022302462516e-16,1.57009245868378e-16,2.22044604925031e-16,3.14018491736755e-16,4.44089209850063e-16,6.28036983473510e-16,8.88178419700125e-16,1.25607396694702e-15,1.77635683940025e-15,2.51214793389404e-15,3.55271367880050e-15,5.02429586778808e-15,7.10542735760100e-15,1.00485917355762e-14,1.42108547152020e-14,2.00971834711523e-14,2.84217094304040e-14,4.01943669423046e-14,5.68434188608080e-14,8.03887338846093e-14,1.13686837721616e-13,1.60777467769219e-13,2.27373675443232e-13,3.21554935538437e-13,4.54747350886464e-13,6.43109871076874e-13,9.09494701772928e-13,1.28621974215375e-12,1.81898940354586e-12,2.57243948430750e-12,3.63797880709171e-12,5.14487896861499e-12,7.27595761418343e-12,1.02897579372300e-11,1.45519152283669e-11,2.05795158744600e-11,2.91038304567337e-11,4.11590317489200e-11,5.82076609134674e-11,8.23180634978399e-11,1.16415321826935e-10,1.64636126995680e-10,2.32830643653870e-10,3.29272253991360e-10,4.65661287307739e-10,6.58544507982719e-10,9.31322574615479e-10,1.31708901596544e-09,1.86264514923096e-09,2.63417803193088e-09,3.72529029846191e-09,5.26835606386175e-09,7.45058059692383e-09,1.05367121277235e-08,1.49011611938477e-08,2.10734242554470e-08,2.98023223876953e-08,4.21468485108940e-08,5.96046447753906e-08,8.42936970217881e-08,1.19209289550781e-07,1.68587394043576e-07,2.38418579101563e-07,3.37174788087152e-07,4.76837158203125e-07,6.74349576174305e-07,9.53674316406250e-07,1.34869915234861e-06,1.90734863281250e-06,2.69739830469722e-06,3.81469726562500e-06,5.39479660939444e-06,7.62939453125000e-06,1.07895932187889e-05,1.52587890625000e-05,2.15791864375777e-05,3.05175781250000e-05,4.31583728751555e-05,6.10351562500000e-05,8.63167457503110e-05,1.22070312500000e-04,1.72633491500622e-04,2.44140625000000e-04,3.45266983001244e-04,4.88281250000000e-04,6.90533966002488e-04,9.76562500000000e-04,1.38106793200498e-03,1.95312500000000e-03,2.76213586400995e-03,3.90625000000000e-03,5.52427172801990e-03,7.81250000000000e-03,1.10485434560398e-02,1.56250000000000e-02,2.20970869120796e-02,3.12500000000000e-02,4.41941738241592e-02,6.25000000000000e-02,8.83883476483184e-02,1.25000000000000e-01,1.76776695296637e-01,2.50000000000000e-01,3.53553390593274e-01,5.00000000000000e-01,7.07106781186548e-01,1.00000000000000e+00,1.41421356237310e+00,2.00000000000000e+00,2.82842712474619e+00,4.00000000000000e+00,5.65685424949238e+00,8.00000000000000e+00,1.13137084989848e+01,1.60000000000000e+01,2.26274169979695e+01,3.20000000000000e+01,4.52548339959390e+01,6.40000000000000e+01,9.05096679918781e+01,1.28000000000000e+02,1.81019335983756e+02,2.56000000000000e+02,3.62038671967512e+02,5.12000000000000e+02,7.24077343935025e+02,1.02400000000000e+03,1.44815468787005e+03,2.04800000000000e+03,2.89630937574010e+03,4.09600000000000e+03,5.79261875148020e+03,8.19200000000000e+03,1.15852375029604e+04,1.63840000000000e+04,2.31704750059208e+04,3.27680000000000e+04,4.63409500118416e+04,6.55360000000000e+04,9.26819000236832e+04,1.31072000000000e+05,1.85363800047366e+05,2.62144000000000e+05,3.70727600094733e+05,5.24288000000000e+05,7.41455200189465e+05,1.04857600000000e+06,1.48291040037893e+06,2.09715200000000e+06,2.96582080075786e+06,4.19430400000000e+06,5.93164160151572e+06,8.38860800000000e+06,1.18632832030314e+07,1.67772160000000e+07,2.37265664060629e+07,3.35544320000000e+07,4.74531328121258e+07,6.71088640000000e+07,9.49062656242516e+07,1.34217728000000e+08,1.89812531248503e+08,2.68435456000000e+08,3.79625062497006e+08,5.36870912000000e+08,7.59250124994012e+08,1.07374182400000e+09,1.51850024998802e+09,2.14748364800000e+09,3.03700049997605e+09,4.29496729600000e+09,6.07400099995210e+09,8.58993459200000e+09,1.21480019999042e+10,1.71798691840000e+10,2.42960039998084e+10,3.43597383680000e+10,4.85920079996168e+10,6.87194767360000e+10,9.71840159992336e+10,1.37438953472000e+11,1.94368031998467e+11,2.74877906944000e+11,3.88736063996934e+11,5.49755813888000e+11,7.77472127993869e+11,1.09951162777600e+12,1.55494425598774e+12,2.19902325555200e+12,3.10988851197548e+12,4.39804651110400e+12,6.21977702395095e+12,8.79609302220800e+12,1.24395540479019e+13,1.75921860444160e+13,2.48791080958038e+13,3.51843720888320e+13,4.97582161916076e+13,7.03687441776640e+13,9.95164323832152e+13,1.40737488355328e+14,1.99032864766430e+14,2.81474976710656e+14,3.98065729532861e+14,5.62949953421312e+14,7.96131459065722e+14,1.12589990684262e+15,1.59226291813144e+15,2.25179981368525e+15,3.18452583626289e+15,4.50359962737050e+15,6.36905167252577e+15,9.00719925474099e+15,1.27381033450515e+16,1.80143985094820e+16,2.54762066901031e+16,3.60287970189640e+16,5.09524133802062e+16,7.20575940379279e+16,1.01904826760412e+17,1.44115188075856e+17,2.03809653520825e+17,2.88230376151712e+17,4.07619307041649e+17,5.76460752303423e+17,8.15238614083299e+17,1.15292150460685e+18,1.63047722816660e+18,2.30584300921369e+18,3.26095445633320e+18,4.61168601842739e+18,6.52190891266639e+18,9.22337203685478e+18,1.30438178253328e+19,1.844674407370960E+19};
// double morn_sqrt2[100]={1.0,1.00498756211209,1.00995049383621,1.01488915650922,1.01980390271856,1.02469507659596,1.02956301409870,1.03440804327886,1.03923048454133,1.04403065089106,1.04880884817015,1.05356537528527,1.05830052442584,1.06301458127347,1.06770782520313,1.07238052947636,1.07703296142690,1.08166538263920,1.08627804912002,1.09087121146357,1.09544511501033,1.10000000000000,1.10453610171873,1.10905365064094,1.11355287256600,1.11803398874989,1.12249721603218,1.12694276695846,1.13137084989848,1.13578166916005,1.14017542509914,1.14455231422596,1.14891252930761,1.15325625946708,1.15758369027902,1.16189500386223,1.16619037896906,1.17046999107196,1.17473401244707,1.17898261225516,1.18321595661992,1.18743420870379,1.19163752878130,1.19582607431014,1.20000000000000,1.20415945787923,1.20830459735946,1.21243556529821,1.21655250605964,1.22065556157337,1.22474487139159,1.22882057274445,1.23288280059380,1.23693168768530,1.24096736459909,1.24498995979887,1.24899959967968,1.25299640861417,1.25698050899765,1.26095202129185,1.26491106406735,1.26885775404495,1.27279220613579,1.27671453348037,1.28062484748657,1.28452325786651,1.28840987267251,1.29228479833201,1.29614813968157,1.30000000000000,1.30384048104053,1.30766968306220,1.31148770486040,1.31529464379659,1.31909059582729,1.32287565553230,1.32664991614216,1.33041346956501,1.33416640641263,1.33790881602597,1.34164078649987,1.34536240470737,1.34907375632320,1.35277492584687,1.35646599662505,1.36014705087354,1.36381816969859,1.36747943311773,1.37113092008021,1.37477270848675,1.37840487520902,1.38202749610853,1.38564064605510,1.38924439894498,1.39283882771841,1.39642400437689,1.40000000000000,1.40356688476182,1.40712472794703,1.41067359796659};
// double mSqrt1(float a)
// {
//     if(a<=0.0) return mNan();
    
//     int *b=(int *)(&a);
//     int c=((*b)>>23);

//     *b=((*b)&0xbfffffff)|0x3f800000;
//     double f=(double)a;
//     int d=(int)(f*100.0);
//     double e=f*100.0/(double)d-1.0;
//     double rst=morn_sqrt1[c]*morn_sqrt2[d-100];

//     double g=e*e;
//     double h=1+0.5*e-0.125*g;
//     g*=e; h+=0.0625*g;
//     g*=e; h-=0.0390625*g;

//     rst=rst*h;
//     return rst;
// }

double mSqrt(double a)
{
    if(a<0.0) return mNan();
    if(a>*(float *)morn_float_sup) return mPow(a,0.5);
    
    double b = a*0.5;

    float a0=(float)a;
    int *c  = (int *)&a0;
    *c  = 0x5f3759df - ((*c)>>1);
    double d = (double)a0;
    
    double f=d*(1.5-(b*d*d));

    double e = b*f*f-0.5;
    double g=e*e*0.5;
    return (1.0+e-g+g*e-2.5*g*g)/f;
}

static double morn_curt1[256]={1.804666057942320e-13,2.273736754432320e-13,2.864728798828940e-13,3.609332115884630e-13,4.547473508864650e-13,5.729457597657870e-13,7.218664231769260e-13,9.094947017729300e-13,1.145891519531570e-12,1.443732846353850e-12,1.818989403545860e-12,2.291783039063150e-12,2.887465692707700e-12,3.637978807091720e-12,4.583566078126300e-12,5.774931385415410e-12,7.275957614183440e-12,9.167132156252590e-12,1.154986277083080e-11,1.455191522836690e-11,1.833426431250520e-11,2.309972554166160e-11,2.910383045673370e-11,3.666852862501040e-11,4.619945108332330e-11,5.820766091346750e-11,7.333705725002070e-11,9.239890216664650e-11,1.164153218269350e-10,1.466741145000410e-10,1.847978043332930e-10,2.328306436538700e-10,2.933482290000830e-10,3.695956086665860e-10,4.656612873077400e-10,5.866964580001660e-10,7.391912173331720e-10,9.313225746154800e-10,1.173392916000330e-09,1.478382434666340e-09,1.862645149230960e-09,2.346785832000660e-09,2.956764869332690e-09,3.725290298461920e-09,4.693571664001330e-09,5.913529738665380e-09,7.450580596923840e-09,9.387143328002650e-09,1.182705947733080e-08,1.490116119384770e-08,1.877428665600530e-08,2.365411895466150e-08,2.980232238769530e-08,3.754857331201060e-08,4.730823790932300e-08,5.960464477539070e-08,7.509714662402120e-08,9.461647581864600e-08,1.192092895507810e-07,1.501942932480420e-07,1.892329516372920e-07,2.384185791015630e-07,3.003885864960850e-07,3.784659032745840e-07,4.768371582031250e-07,6.007771729921690e-07,7.569318065491680e-07,9.536743164062510e-07,1.201554345984340e-06,1.513863613098340e-06,1.907348632812500e-06,2.403108691968680e-06,3.027727226196670e-06,3.814697265625000e-06,4.806217383937360e-06,6.055454452393340e-06,7.629394531250010e-06,9.612434767874710e-06,1.211090890478670e-05,1.525878906250000e-05,1.922486953574940e-05,2.422181780957340e-05,3.051757812500000e-05,3.844973907149880e-05,4.844363561914670e-05,6.103515625000000e-05,7.689947814299770e-05,9.688727123829350e-05,1.220703125000000e-04,1.537989562859950e-04,1.937745424765870e-04,2.441406250000000e-04,3.075979125719910e-04,3.875490849531740e-04,4.882812500000000e-04,6.151958251439810e-04,7.750981699063480e-04,9.765625000000000e-04,1.230391650287960e-03,1.550196339812700e-03,1.953125000000000e-03,2.460783300575930e-03,3.100392679625390e-03,3.906250000000000e-03,4.921566601151850e-03,6.200785359250780e-03,7.812500000000000e-03,9.843133202303700e-03,1.240157071850160e-02,1.562500000000000e-02,1.968626640460740e-02,2.480314143700310e-02,3.125000000000000e-02,3.937253280921480e-02,4.960628287400620e-02,6.250000000000000e-02,7.874506561842960e-02,9.921256574801250e-02,1.250000000000000e-01,1.574901312368590e-01,1.984251314960250e-01,2.500000000000000e-01,3.149802624737180e-01,3.968502629920500e-01,5.000000000000000e-01,6.299605249474370e-01,7.937005259841000e-01,1.000000000000000e+00,1.259921049894870e+00,1.587401051968200e+00,2.000000000000000e+00,2.519842099789750e+00,3.174802103936400e+00,4.000000000000000e+00,5.039684199579490e+00,6.349604207872800e+00,8.000000000000000e+00,1.007936839915900e+01,1.269920841574560e+01,1.600000000000000e+01,2.015873679831800e+01,2.539841683149120e+01,3.200000000000000e+01,4.031747359663590e+01,5.079683366298240e+01,6.400000000000000e+01,8.063494719327190e+01,1.015936673259650e+02,1.280000000000000e+02,1.612698943865440e+02,2.031873346519290e+02,2.560000000000000e+02,3.225397887730870e+02,4.063746693038590e+02,5.120000000000000e+02,6.450795775461750e+02,8.127493386077180e+02,1.024000000000000e+03,1.290159155092350e+03,1.625498677215440e+03,2.048000000000000e+03,2.580318310184700e+03,3.250997354430870e+03,4.096000000000000e+03,5.160636620369400e+03,6.501994708861740e+03,8.192000000000000e+03,1.032127324073880e+04,1.300398941772350e+04,1.638400000000000e+04,2.064254648147760e+04,2.600797883544700e+04,3.276800000000000e+04,4.128509296295520e+04,5.201595767089390e+04,6.553600000000000e+04,8.257018592591040e+04,1.040319153417880e+05,1.310720000000000e+05,1.651403718518210e+05,2.080638306835760e+05,2.621440000000000e+05,3.302807437036410e+05,4.161276613671510e+05,5.242880000000000e+05,6.605614874072830e+05,8.322553227343030e+05,1.048576000000000e+06,1.321122974814570e+06,1.664510645468610e+06,2.097152000000000e+06,2.642245949629130e+06,3.329021290937210e+06,4.194304000000000e+06,5.284491899258260e+06,6.658042581874420e+06,8.388607999999990e+06,1.056898379851650e+07,1.331608516374880e+07,1.677721600000000e+07,2.113796759703300e+07,2.663217032749770e+07,3.355443200000000e+07,4.227593519406610e+07,5.326434065499540e+07,6.710886399999990e+07,8.455187038813220e+07,1.065286813099910e+08,1.342177280000000e+08,1.691037407762640e+08,2.130573626199810e+08,2.684354560000000e+08,3.382074815525290e+08,4.261147252399630e+08,5.368709119999990e+08,6.764149631050570e+08,8.522294504799260e+08,1.073741824000000e+09,1.352829926210110e+09,1.704458900959850e+09,2.147483648000000e+09,2.705659852420230e+09,3.408917801919700e+09,4.294967295999990e+09,5.411319704840460e+09,6.817835603839410e+09,8.589934591999990e+09,1.082263940968090e+10,1.363567120767880e+10,1.717986918400000e+10,2.164527881936180e+10,2.727134241535760e+10,3.435973836800000e+10,4.329055763872370e+10,5.454268483071520e+10,6.871947673599990e+10,8.658111527744730e+10,1.090853696614300e+11,1.374389534720000e+11,1.731622305548950e+11,2.181707393228610e+11,2.748779069440000e+11,3.463244611097890e+11,4.363414786457220e+11,5.497558138879990e+11,6.926489222195780e+11,8.726829572914440e+11,1.099511627776000e+12,1.385297844439160e+12,1.745365914582890e+12,2.199023255552000e+12,2.770595688878310e+12,3.490731829165770e+12,4.398046511103990e+12,5.541191377756630e+12,6.981463658331550e+12};
static double morn_curt2[100]={1.0,1.00332228354209,1.00662270956011,1.00990163404996,1.01315940382018,1.01639635681485,1.01961282242222,1.02280912176967,1.02598556800602,1.02914246657151,1.03228011545637,1.03539880544841,1.03849882037022,1.04158043730656,1.04464392682232,1.04768955317165,1.05071757449858,1.05372824302963,1.05672180525872,1.05969850212481,1.06265856918261,1.06560223676661,1.06852973014888,1.07144126969077,1.07433707098897,1.07721734501594,1.08008229825529,1.08293213283200,1.08576704663796,1.08858723345293,1.09139288306111,1.09418418136353,1.09696131048652,1.09972444888627,1.10247377144973,1.10520944959212,1.10793165135089,1.11064054147667,1.11333628152095,1.11601902992092,1.11868894208140,1.12134617045410,1.12399086461423,1.12662317133458,1.12924323465723,1.13185119596295,1.13444719403828,1.13703136514059,1.13960384306101,1.14216475918538,1.14471424255333,1.14725241991549,1.14977941578897,1.15229535251109,1.15480035029155,1.15729452726294,1.15977799952980,1.16225088121617,1.16471328451175,1.16716531971671,1.16960709528515,1.17203871786732,1.17446029235066,1.17687192189956,1.17927370799407,1.18166575046750,1.18404814754290,1.18642099586858,1.18878439055263,1.19113842519643,1.19348319192734,1.19581878143035,1.19814528297902,1.20046278446547,1.20277137242962,1.20507113208762,1.20736214735954,1.20964450089633,1.21191827410604,1.21418354717940,1.21644039911468,1.21868890774198,1.22092914974679,1.22316120069309,1.22538513504568,1.22760102619215,1.22980894646410,1.23200896715799,1.23420115855534,1.23638558994257,1.23856232963017,1.24073144497159,1.24289300238154,1.24504706735389,1.24719370447911,1.24933297746139,1.25146494913519,1.25358968148155,1.25570723564389,1.25781767194355};
double mCurt(double a)
{
    if(a<=0.0) return mNan();
    if(a>*(float *)morn_float_sup) return mPow(a,1.0/3.0);

    float a0=(float)a;
    int *b=(int *)(&a0);
    int c=((*b)>>23);

    *b=((*b)&0xbfffffff)|0x3f800000;
    
    double f=(double)a0;
    int d=(int)(f*100.0);
    double e=f*100.0/(double)d-1.0;
    double rst=morn_curt1[c]*morn_curt2[d-100];

    double g=e*e;
    return rst*(1+0.333333333333333*e-0.111111111111111*g+0.061728395061728*g*e-0.041152263374486*g*g);
}

double m_Gaussian(double a,double mean,double variance)
{
    double b = (a-mean);b=0-b*b/(variance+variance);
    return mExp(b)/(mSqrt(variance)*2.506628274631000502415765284811);
}

// double m_Gaussian_n(double *a,double *mean,double *variance,int n)
// {
//     double c=0.0,d=1.0;
//     for(int i=0;i<n;i++)
//     {
//         double b = (a[i]-mean[i]);
//         c+=0-b*b/(variance[i]+variance[i]);
//         d*=mSqrt(variance[i])
//     }
//     return mExp(c)/(d*2.506628274631000502415765284811);
// }


void mMean(float *in,int num,float *sum,float *mean)
{
    float m;
    int i;
    mException((INVALID_POINTER(in))||(num <= 0),EXIT,"invalid input");
    
    m = 0.0f;
    for(i=0;i<num;i++)
        m = m + in[i];
    
    if(!INVALID_POINTER(sum)) *sum = m;
    if(!INVALID_POINTER(mean)) *mean = m/((float)num);
}

void mVariance(float *in,int num,float *mean,float *variance)
{
    float sum=0.0f;
    float var=0.0f;
    int i;
    mException((INVALID_POINTER(in))||(num <= 0)||(INVALID_POINTER(variance)),EXIT,"invalid input");
    
    for(i=0;i<num;i++)
    {
        sum = sum + in[i];
        var = var + in[i]*in[i];
    }
    sum = sum/((float)num);
    if(!INVALID_POINTER(mean)) *mean = sum;
    *variance = var/((float)num) - (sum*sum);
}

void mCovariance(float *in1,float *in2,int num,float *mean1,float *mean2,float *covariance)
{
    float sum1 = 0.0f;
    float sum2 = 0.0f;
    float cosum = 0.0f;
    int i;
    
    mException((INVALID_POINTER(in1))||(INVALID_POINTER(in2))||(num <= 0)||(INVALID_POINTER(covariance)),EXIT,"invalid input");
    for(i=0;i<num;i++)
    {
        sum1 =sum1 + in1[i];
        sum2 =sum2 + in2[i];
        cosum = cosum +in1[i] * in2[i];
    }
    sum1 = sum1/((float)num);
    sum2 = sum2/((float)num);
    if(!INVALID_POINTER(mean1)) *mean1 = sum1;
    if(!INVALID_POINTER(mean2)) *mean2 = sum1;
    *covariance = cosum/((float)num) - sum1*sum2;
}

#define MID_INDEX(I1,I2,I3) (((value[I1]>value[I2])==(value[I2]>=value[I3]))?I2:(((value[I1]>value[I2])==(value[I3]>=value[I1]))?I1:I3))
void mApproxMidValue(float *value,int num,float *mid,int *idx)
{
    int n;for(n=9;n<num/4;n=n*3);
    int *index = (int *)mMalloc(sizeof(int)*n);
    float step = (float)num/(float)n;for(int i=0;i<n;i++) index[i] = i*step;
    for(;n>1;n=n/3)
    {
        for(int i=0,j=0;i<n;i+=3,j+=1)
        {
            printf("%f,%f,%f",value[index[i]],value[index[i+1]],value[index[i+2]]);
            index[j] = MID_INDEX(index[i],index[i+1],index[i+2]);
            printf("-->%f\n",value[index[j]]);
        }
        printf("\n");
    }
    
    if(mid != NULL) *mid = value[index[0]];
    if(idx != NULL) *idx = index[0];
    
    mFree(index);
}



int _GreatestCommonDivisor(int a,int b)
{
    return b?_GreatestCommonDivisor(b,a%b):a;
}
int GreatestCommonDivisor(int n,...)
{
    va_list para;
    va_start(para,n);
    int a=va_arg(para,int);
    for(int i=1;i<n;i++)
    {
        int b=va_arg(para,int);
        a=_GreatestCommonDivisor(b,a);
    }
    va_end(para);
    return a;
}
int _LowestCommonMultiple(int a,int b)
{
    return (a/_GreatestCommonDivisor(a,b)*b);
}
int LowestCommonMultiple(int n,...)
{
    va_list para;
    va_start(para,n);
    int a=va_arg(para,int);
    for(int i=1;i<n;i++)
    {
        int b=va_arg(para,int);
        a=_LowestCommonMultiple(a,b);
    }
    va_end(para);
    return a;
}

int mBinaryCeil(int data)
{
    int floor = mBinaryFloor(data);
    if(floor==data) return data;
    return (data>0)?(floor*2):(floor/2);
}

int mBinaryFloor(int data)
{
    if (data<0) return (0-mBinaryCeil(0-data));
    int v[16]={0,1,2,2,4,4,4,4,8,8,8,8,8,8,8,8};
    if(data<16) return v[data];
    if(data<256) return (v[data>>4]<<4);
    if(data<4096) return (v[data>>8]<<8);
    if(data<65536) return (v[data>>12]<<12);
    if(data<1048576) return (v[data>>16]<<16);
    if(data<16777216) return (v[data>>20]<<20);
    if(data<268435456) return (v[data>>24]<<24);
    return (v[data>>28]<<28);
}

int mBinaryRound(int data)
{
    int floor = mBinaryFloor(data);
    int ceil = (data>0)?(floor*2):(floor/2);
    return ((ceil-data)<=(data-floor))?ceil:floor;
}



unsigned int m_Hash(const char *in,int size)
{
    unsigned int out;
    int i;
    
    mException(INVALID_POINTER(in),EXIT,"invalid input");
    
    out = 0x811C9DC5;
    for(i=0;(size<=0)?(in[i]!='\0'):(i<=size);i++)
    {
        out = out^(unsigned int)in[i];
        out = (out<<24)+(out<<8)+(out<<6)+(out<<4)+(out<<3)+(out<<2)+out;
    }
    
    return out;
}
/*
struct HandlePermutation
{
    int *idx;
    int *flag;
    int num;
    int total;
};
void endPermutation(struct HandlePermutation *handle)
{
    if(handle->idx !=NULL) mFree(handle->idx );
    if(handle->flag!=NULL) mFree(handle->flag);
}
#define HASH_Permutation 0xf4740f4b
int mPermutation(int *idx,int num,int total)
{
    mException(INVALID_POINTER(idx),EXIT,"invalid input");
    MHandle *hdl = mHandle(mMornObject(idx,0),Permutation);
    struct HandlePermutation *handle = (struct HandlePermutation *)(hdl->handle);
    if(hdl->valid==0)
    {
        if(total<0) total=num;
        mException((num<0)||(num>total),EXIT,"invalid input combination number");
        if((handle->idx!=NULL)&&(handle->num<num)) {mFree(handle->idx);handle->idx=NULL;}
        if(handle->idx==NULL) handle->idx = (int *)mMalloc(num*sizeof(int));
        if((handle->flag!=NULL)&&(handle->total<total)) {mFree(handle->flag);handle->flag=NULL;}
        if(handle->flag==NULL) handle->flag= (int *)mMalloc(total*sizeof(int));
        for(int i=0;i<num;i++) {handle->idx[i]=i;handle->flag[i]=1;}
        for(int i=num;i<total;i++) handle->flag[i]=0;
        handle->num = num;handle->total=total;
        hdl->valid = 1;
        
        memcpy(idx,handle->idx,num*sizeof(int));
        return MORN_SUCCESS;
    }
    else
    {
        mException((handle->num  !=num  )&&(num  >0),EXIT,"invalid input combination number");num  =handle->num  ;
        mException((handle->total!=total)&&(total>0),EXIT,"invalid input combination number");total=handle->total;
    }

    int n;for(n=num-1;n>=0;n--)
    {
        int j = handle->idx[n];
        handle->flag[j]=0;
        for(j=handle->idx[n]+1;j<total;j++)
        {
            if(handle->flag[j]==0)
            {
                handle->idx[n]=j;
                handle->flag[j]=1;
                break;
            }
        }
        if(j<total) break;
        if(n==0) 
        {
            mFree(handle->idx );handle->idx =NULL;
            mFree(handle->flag);handle->flag=NULL;
            hdl->valid = 0;
            return MORN_FAIL;
        }
    }
    for(int i=n+1;i<num;i++)
    {
        for(int j=0;j<total;j++)
        {
            if(handle->flag[j]==0)
            {
                handle->idx[i]=j;
                handle->flag[j]=1;
                break;
            }
        }
    }
    memcpy(idx,handle->idx,num*sizeof(int));
    return MORN_SUCCESS;
}
*/


struct HandleCombination
{
    int *idx;
    int num;
    int list_num;
    MList *out;
    int *idx2;
};
void endCombination(struct HandleCombination *handle)
{
    if(handle->idx !=NULL) mFree(handle->idx);
    if(handle->idx2!=NULL) mFree(handle->idx2);
    if(handle->out !=NULL) mListRelease(handle->out);
}
#define HASH_Combination 0x110249ec
MList *mCombination(MList *list,int num)
{
    mException(INVALID_POINTER(list),EXIT,"invalid input");
    int list_num = list->num;
    MHandle *hdl = mHandle(list,Combination);
    struct HandleCombination *handle = (struct HandleCombination *)(hdl->handle);
    if((hdl->valid==0)||(handle->num!=num))
    {
        mException((num<0)||(num>list_num),EXIT,"invalid input combination number");
        if((handle->idx!=NULL)&&(handle->num<num)) {mFree(handle->idx);handle->idx=NULL;}
        if(handle->idx==NULL) handle->idx = (int *)mMalloc(num*sizeof(int));
        for(int i=0;i<num;i++) handle->idx[i]=i;
        handle->num = num;handle->list_num=list_num;
        
        if(handle->out!=NULL) mListRelease(handle->out);
        handle->out = mListCreate(num,list->data);
        
        hdl->valid = 1;
        return handle->out;
    }
    mException((handle->num !=num)&&(num > 0),EXIT,"invalid input combination number");num=handle->num;
    mException((handle->list_num!=list_num),EXIT,"invalid input combination number");

    int n;for(n=num-1;n>=0;n--)
    {
        handle->idx[n]++;
        if(handle->idx[n]<=list_num-num+n) break;
    }
    if(n<0) 
    {
        mFree(handle->idx);handle->idx =NULL;
        hdl->valid = 0;
        return NULL;
    }
    for(int i=n+1;i<num;i++) handle->idx[i]=handle->idx[i-1]+1;

    for(int i=0;i<num;i++) handle->out->data[i]=list->data[handle->idx[i]];
    
    return handle->out;
}

int _Permutation(int *idx,int num)
{
    int buff;
    if(idx[num-2]<idx[num-1]) {buff=idx[num-2];idx[num-2]=idx[num-1];idx[num-1]=buff;return 1;}
    int n;for(n=num-3;n>=0;n--)
    {
        if(idx[n]<idx[n+1]) break;
    }
    if(n<0) return DFLT;
    int i,j;
    for(i=num-1;i>n;i--) {if(idx[i]>idx[n]) {buff=idx[n];idx[n]=idx[i];idx[i]=buff;break;}}
    for(i=num-1,j=n+1;i>j;i--,j++) {buff=idx[j];idx[j]=idx[i];idx[i]=buff;}
    return 1;
}

MList *m_Permutation(MList *list,int num)
{
    mException(INVALID_POINTER(list),EXIT,"invalid input");
    if(num<0) num=list->num;
    MHandle *hdl = mHandle(list,Combination);
    struct HandleCombination *handle = (struct HandleCombination *)(hdl->handle);

    if((hdl->valid==0)||(handle->num!=num))
    {
        mCombination(list,num);
        if(handle->idx2!=NULL) mFree(handle->idx2);
        handle->idx2=mMalloc(num*sizeof(int));
        memcpy(handle->idx2,handle->idx,num*sizeof(int));
        return handle->out;
    }
    
    if(_Permutation(handle->idx2,num)>0)
    {
        for(int i=0;i<num;i++) handle->out->data[i]=list->data[handle->idx2[i]];
        return handle->out;
    }
    if(mCombination(list,num)>0)
    {
        memcpy(handle->idx2,handle->idx,num*sizeof(int));
        return handle->out;
    }
    return NULL;
}
